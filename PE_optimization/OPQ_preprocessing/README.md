# OPQ Preprocessing

The resource consumption of this module is very low, thus recommend using the unroll factor 8 version because it should deliver enough performance for any index setting (50K+ QPS, less than 1% resource consumption).

## Unroll factor 8 Version

Performance:

Total time = query_num * (L_load + (L_compute + (D * D) / UNROLL_FACTOR * II) + L_write)

Here, L_load = L_write = 128 CC, L_compute = 37, D = 128, UNROLL_FACTOR = 8

Suppose query_num = 10000, 10000 * (128 + 37 + 128 * 128 / 8 + 128) = 23410000, very close to HLS report (23460000).

Suppose 140 MHz frequency, this is 10000 / (23460000 / 140 / 1e6) = **59676 QPS**

```
+ Timing: 
    * Summary: 
    +--------+---------+----------+------------+
    |  Clock |  Target | Estimated| Uncertainty|
    +--------+---------+----------+------------+
    |ap_clk  | 7.14 ns | 5.018 ns |   1.93 ns  |
    +--------+---------+----------+------------+

+ Latency: 
    * Summary: 
    +----------+----------+-----------+-----------+----------+----------+---------+
    |   Latency (cycles)  |   Latency (absolute)  |       Interval      | Pipeline|
    |    min   |    max   |    min    |    max    |    min   |    max   |   Type  |
    +----------+----------+-----------+-----------+----------+----------+---------+
    |  23476387|  23476387| 0.168 sec | 0.168 sec |  23476387|  23476387|   none  |
    +----------+----------+-----------+-----------+----------+----------+---------+

    + Detail: 
        * Instance: 
        N/A

        * Loop: 
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+
        |             |   Latency (cycles)  | Iteration|  Initiation Interval  |  Trip |          |
        |  Loop Name  |    min   |    max   |  Latency |  achieved |   target  | Count | Pipelined|
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+
        |- Loop 1     |     16384|     16384|         2|          1|          1|  16384|    yes   |
        |- Loop 2     |  23460000|  23460000|      2346|          -|          -|  10000|    no    |
        | + Loop 2.1  |       128|       128|         2|          1|          1|    128|    yes   |
        | + Loop 2.2  |      2083|      2083|        37|          1|          1|   2048|    yes   |
        | + Loop 2.3  |       128|       128|         2|          1|          1|    128|    yes   |
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+
```

Resource:

```
================================================================
== Utilization Estimates
================================================================
* Summary:
+---------------------+---------+-------+---------+---------+-----+
|         Name        | BRAM_18K| DSP48E|    FF   |   LUT   | URAM|
+---------------------+---------+-------+---------+---------+-----+
|DSP                  |        -|      -|        -|        -|    -|
|Expression           |        -|      -|        0|      325|    -|
|FIFO                 |        -|      -|        -|        -|    -|
|Instance             |        -|     40|     2872|     2416|    -|
|Memory               |       33|      -|      512|       64|    0|
|Multiplexer          |        -|      -|        -|      503|    -|
|Register             |        0|      -|     1750|      352|    -|
+---------------------+---------+-------+---------+---------+-----+
|Total                |       33|     40|     5134|     3660|    0|
+---------------------+---------+-------+---------+---------+-----+
|Available SLR        |     1344|   3008|   869120|   434560|  320|
+---------------------+---------+-------+---------+---------+-----+
|Utilization SLR (%)  |        2|      1|    ~0   |    ~0   |    0|
+---------------------+---------+-------+---------+---------+-----+
|Available            |     4032|   9024|  2607360|  1303680|  960|
+---------------------+---------+-------+---------+---------+-----+
|Utilization (%)      |    ~0   |   ~0  |    ~0   |    ~0   |    0|
+---------------------+---------+-------+---------+---------+-----+
```

## Unroll factor 4 Version

Performance: 

```
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+
        |             |   Latency (cycles)  | Iteration|  Initiation Interval  |  Trip |          |
        |  Loop Name  |    min   |    max   |  Latency |  achieved |   target  | Count | Pipelined|
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+
        |- Loop 1     |     16384|     16384|         2|          1|          1|  16384|    yes   |
        |- Loop 2     |  43780000|  43780000|      4378|          -|          -|  10000|    no    |
        | + Loop 2.1  |       128|       128|         2|          1|          1|    128|    yes   |
        | + Loop 2.2  |      4115|      4115|        21|          1|          1|   4096|    yes   |
        | + Loop 2.3  |       128|       128|         2|          1|          1|    128|    yes   |
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+

```

Resource: 

```
================================================================
== Utilization Estimates
================================================================
* Summary: 
+---------------------+---------+------+---------+---------+-----+
|         Name        | BRAM_18K|  DSP |    FF   |   LUT   | URAM|
+---------------------+---------+------+---------+---------+-----+
|DSP                  |        -|     -|        -|        -|    -|
|Expression           |        -|     -|        0|      205|    -|
|FIFO                 |        -|     -|        -|        -|    -|
|Instance             |        -|    20|     1436|     1308|    -|
|Memory               |       37|     -|        0|        0|    -|
|Multiplexer          |        -|     -|        -|      383|    -|
|Register             |        -|     -|     1223|      256|    -|
+---------------------+---------+------+---------+---------+-----+
|Total                |       37|    20|     2659|     2152|    0|
+---------------------+---------+------+---------+---------+-----+
|Available SLR        |     1344|  3008|   869120|   434560|  320|
+---------------------+---------+------+---------+---------+-----+
|Utilization SLR (%)  |        2|  ~0  |    ~0   |    ~0   |    0|
+---------------------+---------+------+---------+---------+-----+
|Available            |     4032|  9024|  2607360|  1303680|  960|
+---------------------+---------+------+---------+---------+-----+
|Utilization (%)      |    ~0   |  ~0  |    ~0   |    ~0   |    0|
+---------------------+---------+------+---------+---------+-----+
```

## Unroll factor 2 Version

Performance: 

```
        * Loop: 
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+
        |             |   Latency (cycles)  | Iteration|  Initiation Interval  |  Trip |          |
        |  Loop Name  |    min   |    max   |  Latency |  achieved |   target  | Count | Pipelined|
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+
        |- Loop 1     |     16384|     16384|         2|          1|          1|  16384|    yes   |
        |- Loop 2     |  84660000|  84660000|      8466|          -|          -|  10000|    no    |
        | + Loop 2.1  |       128|       128|         2|          1|          1|    128|    yes   |
        | + Loop 2.2  |      8203|      8203|        13|          1|          1|   8192|    yes   |
        | + Loop 2.3  |       128|       128|         2|          1|          1|    128|    yes   |
        +-------------+----------+----------+----------+-----------+-----------+-------+----------+

```

Resource: 

```

================================================================
== Utilization Estimates
================================================================
* Summary: 
+---------------------+---------+------+---------+---------+-----+
|         Name        | BRAM_18K|  DSP |    FF   |   LUT   | URAM|
+---------------------+---------+------+---------+---------+-----+
|DSP                  |        -|     -|        -|        -|    -|
|Expression           |        -|     -|        0|      206|    -|
|FIFO                 |        -|     -|        -|        -|    -|
|Instance             |        -|    10|      718|      707|    -|
|Memory               |       33|     -|        0|        0|    -|
|Multiplexer          |        -|     -|        -|      323|    -|
|Register             |        -|     -|      816|      192|    -|
+---------------------+---------+------+---------+---------+-----+
|Total                |       33|    10|     1534|     1428|    0|
+---------------------+---------+------+---------+---------+-----+
|Available SLR        |     1344|  3008|   869120|   434560|  320|
+---------------------+---------+------+---------+---------+-----+
|Utilization SLR (%)  |        2|  ~0  |    ~0   |    ~0   |    0|
+---------------------+---------+------+---------+---------+-----+
|Available            |     4032|  9024|  2607360|  1303680|  960|
+---------------------+---------+------+---------+---------+-----+
|Utilization (%)      |    ~0   |  ~0  |    ~0   |    ~0   |    0|
+---------------------+---------+------+---------+---------+-----+
```


## No Unroll Version

```
        * Loop: 
        +-------------+-----------+-----------+----------+-----------+-----------+-------+----------+
        |             |    Latency (cycles)   | Iteration|  Initiation Interval  |  Trip |          |
        |  Loop Name  |    min    |    max    |  Latency |  achieved |   target  | Count | Pipelined|
        +-------------+-----------+-----------+----------+-----------+-----------+-------+----------+
        |- Loop 1     |      16384|      16384|         2|          1|          1|  16384|    yes   |
        |- Loop 2     |  166540000|  166540000|     16654|          -|          -|  10000|    no    |
        | + Loop 2.1  |        128|        128|         2|          1|          1|    128|    yes   |
        | + Loop 2.2  |      16391|      16391|         9|          1|          1|  16384|    yes   |
        | + Loop 2.3  |        128|        128|         2|          1|          1|    128|    yes   |
        +-------------+-----------+-----------+----------+-----------+-----------+-------+----------+

================================================================
== Utilization Estimates
================================================================
* Summary: 
+---------------------+---------+------+---------+---------+-----+
|         Name        | BRAM_18K|  DSP |    FF   |   LUT   | URAM|
+---------------------+---------+------+---------+---------+-----+
|DSP                  |        -|     -|        -|        -|    -|
|Expression           |        -|     -|        0|      209|    -|
|FIFO                 |        -|     -|        -|        -|    -|
|Instance             |        -|     5|      359|      422|    -|
|Memory               |       31|     -|        0|        0|    -|
|Multiplexer          |        -|     -|        -|      302|    -|
|Register             |        -|     -|      696|      192|    -|
+---------------------+---------+------+---------+---------+-----+
|Total                |       31|     5|     1055|     1125|    0|
+---------------------+---------+------+---------+---------+-----+
|Available SLR        |     1344|  3008|   869120|   434560|  320|
+---------------------+---------+------+---------+---------+-----+
|Utilization SLR (%)  |        2|  ~0  |    ~0   |    ~0   |    0|
+---------------------+---------+------+---------+---------+-----+
|Available            |     4032|  9024|  2607360|  1303680|  960|
+---------------------+---------+------+---------+---------+-----+
|Utilization (%)      |    ~0   |  ~0  |    ~0   |    ~0   |    0|
+---------------------+---------+------+---------+---------+-----+
```